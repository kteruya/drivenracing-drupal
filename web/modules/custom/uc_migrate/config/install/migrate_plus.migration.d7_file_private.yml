id: d7_file_private
label: 'Drupal 7 files (private, override)'
status: true
migration_group: default
dependencies:
  enforced:
    module: [migrate_drupal, migrate_plus, file]

source:
  plugin: d7_file
  scheme: private
  constants:
    source_base_path: /home/drupal11.drivenracing.com/legacy_d7/private/files

process:
  fid:
    - plugin: get
      source: fid
  filename:
    - plugin: get
      source: filename

  # Strip 'private://' to get a relative path
  source_rel_from_uri:
    plugin: str_replace
    search: 'private://'
    replace: ''
    source: uri

  # Join legacy base path + relative path; then urlencode for file_copy
  source_full_path:
    - plugin: concat
      delimiter: /
      source:
        - constants/source_base_path
        - '@source_rel_from_uri'
    - plugin: urlencode

  # Copy from legacy absolute path to Drupal's private:// destination
  uri:
    - plugin: file_copy
      source:
        - '@source_full_path'
        - uri

  filemime:
    - plugin: get
      source: filemime
  status:
    - plugin: get
      source: status
  created:
    - plugin: get
      source: timestamp
  changed:
    - plugin: get
      source: timestamp
  uid:
    - plugin: get
      source: uid

destination:
  plugin: 'entity:file'
